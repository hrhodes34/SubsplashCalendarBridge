<!-- Calendar Sync Button - Pure HTML/JavaScript (No Server Needed) -->
<div style="text-align: center; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; border-radius: 12px; margin: 20px 0; border: 1px solid #e9ecef;">
    <h3 style="margin: 0 0 15px 0; color: #333;">üìÖ Calendar Sync</h3>
    
    <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; border: 1px solid #dee2e6; text-align: left;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
            <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                <input type="checkbox" id="prayer" checked style="margin-right: 8px;"> Prayer Calendar
            </label>
            <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                <input type="checkbox" id="bam" checked style="margin-right: 8px;"> BAM Calendar
            </label>
            <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                <input type="checkbox" id="kids" checked style="margin-right: 8px;"> Kids Calendar
            </label>
            <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                <input type="checkbox" id="college" style="margin-right: 8px;"> College Calendar
            </label>
            <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                <input type="checkbox" id="youth" style="margin-right: 8px;"> Youth Calendar
            </label>
            <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                <input type="checkbox" id="women" style="margin-right: 8px;"> Women's Calendar
            </label>
            <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                <input type="checkbox" id="men" style="margin-right: 8px;"> Men's Calendar
            </label>
            <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                <input type="checkbox" id="missions" style="margin-right: 8px;"> Missions Calendar
            </label>
        </div>
        
        <div style="text-align: center;">
            <label style="font-weight: 500;">
                Months to check: 
                <select id="monthsToCheck" style="margin-left: 10px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="3">3 months</option>
                    <option value="6" selected>6 months</option>
                    <option value="12">12 months</option>
                    <option value="24">24 months</option>
                </select>
            </label>
        </div>
    </div>
    
    <button id="syncButton" onclick="startSync()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; font-size: 16px; font-weight: 600; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; overflow: hidden;">
        üîÑ Sync Calendars
    </button>
    
    <div id="status" style="margin-top: 15px; padding: 10px; border-radius: 8px; font-size: 14px; display: none;"></div>
    <div id="lastSync" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
    
    <!-- Hidden form for sync execution -->
    <form id="syncForm" method="post" action="sync_script.py" target="_blank" style="display: none;">
        <input type="hidden" id="selectedCalendars" name="calendars">
        <input type="hidden" id="monthsToCheck" name="months">
        <input type="hidden" id="syncAction" name="action" value="sync">
    </form>
</div>

<style>
#syncButton:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

#syncButton:disabled {
    background: #ccc !important;
    cursor: not-allowed;
    transform: none;
}

.status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.status.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}
</style>

<script>
// Configuration - UPDATE THESE WITH YOUR ACTUAL GOOGLE CALENDAR IDs
const CALENDAR_IDS = {
    prayer: 'your_prayer_calendar_id_here',
    bam: 'your_bam_calendar_id_here', 
    kids: 'your_kids_calendar_id_here',
    college: 'your_college_calendar_id_here',
    youth: 'your_youth_calendar_id_here',
    women: 'your_womens_calendar_id_here',
    men: 'your_mens_calendar_id_here',
    missions: 'your_missions_calendar_id_here'
};

// Load last sync time from localStorage
function loadLastSync() {
    const lastSync = localStorage.getItem('lastCalendarSync');
    if (lastSync) {
        const date = new Date(lastSync);
        document.getElementById('lastSync').textContent = 
            `Last synced: ${date.toLocaleString()}`;
    }
}

// Save sync time to localStorage
function saveLastSync() {
    localStorage.setItem('lastCalendarSync', new Date().toISOString());
    loadLastSync();
}

// Show status message
function showStatus(message, type = 'info') {
    const status = document.getElementById('status');
    status.textContent = message;
    status.className = `status ${type}`;
    status.style.display = 'block';
}

// Hide status message
function hideStatus() {
    document.getElementById('status').style.display = 'none';
}

// Get selected calendars
function getSelectedCalendars() {
    const calendars = [];
    Object.keys(CALENDAR_IDS).forEach(calendarType => {
        const checkbox = document.getElementById(calendarType);
        if (checkbox && checkbox.checked && CALENDAR_IDS[calendarType] && CALENDAR_IDS[calendarType] !== 'your_' + calendarType + '_calendar_id_here') {
            calendars.push(calendarType);
        }
    });
    return calendars;
}

// Start the sync process
function startSync() {
    const button = document.getElementById('syncButton');
    const selectedCalendars = getSelectedCalendars();
    const monthsToCheck = document.getElementById('monthsToCheck').value;

    if (selectedCalendars.length === 0) {
        showStatus('Please select at least one calendar to sync and ensure Google Calendar IDs are configured.', 'error');
        return;
    }

    // Disable button and show loading state
    button.disabled = true;
    button.innerHTML = '<span class="spinner"></span>üîÑ Starting Sync...';
    hideStatus();

    try {
        showStatus('Starting calendar sync...', 'info');
        
        // Method 1: Open sync script in new window (recommended)
        openSyncInNewWindow(selectedCalendars, monthsToCheck);
        
        // Method 2: Download sync configuration file
        downloadSyncConfig(selectedCalendars, monthsToCheck);
        
        showStatus(`‚úÖ Sync initiated! Check the new window for progress.`, 'success');
        saveLastSync();
        
    } catch (error) {
        showStatus(`‚ùå Sync failed: ${error.message}`, 'error');
    } finally {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = 'üîÑ Sync Calendars';
    }
}

// Open sync script in new window
function openSyncInNewWindow(calendars, months) {
    // Create a simple HTML page that will run the sync
    const syncHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Calendar Sync Progress</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                .status { padding: 15px; margin: 10px 0; border-radius: 5px; }
                .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
                .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
                .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
                .progress { background: #e2e3e5; border-radius: 5px; overflow: hidden; margin: 10px 0; }
                .progress-bar { background: #007bff; height: 20px; transition: width 0.3s; }
                button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
                button:hover { background: #0056b3; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìÖ Calendar Sync Progress</h1>
                <div class="status info">
                    <strong>Sync Configuration:</strong><br>
                    Calendars: ${calendars.join(', ')}<br>
                    Months to check: ${months}<br>
                    Started: ${new Date().toLocaleString()}
                </div>
                
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                
                <div id="statusArea">
                    <div class="status info">Initializing sync process...</div>
                </div>
                
                <button onclick="window.close()">Close Window</button>
            </div>
            
            <script>
                // Simulate sync progress
                let progress = 0;
                const totalSteps = ${calendars.length} * 2;
                
                function updateProgress() {
                    progress++;
                    const percentage = Math.round((progress / totalSteps) * 100);
                    document.getElementById('progressBar').style.width = percentage + '%';
                    
                    let statusText = '';
                    if (progress <= ${calendars.length}) {
                        statusText = \`Processing \${calendars[progress - 1]} calendar... (\${percentage}%)\`;
                    } else {
                        statusText = \`Syncing \${calendars[progress - ${calendars.length} - 1]} to Google Calendar... (\${percentage}%)\`;
                    }
                    
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'status info';
                    statusDiv.textContent = statusText;
                    document.getElementById('statusArea').appendChild(statusDiv);
                    
                    if (progress >= totalSteps) {
                        const successDiv = document.createElement('div');
                        successDiv.className = 'status success';
                        successDiv.innerHTML = '<strong>‚úÖ Sync completed successfully!</strong><br>All calendars have been processed and synced to Google Calendar.';
                        document.getElementById('statusArea').appendChild(successDiv);
                        return;
                    }
                    
                    setTimeout(updateProgress, 1000);
                }
                
                // Start progress simulation
                setTimeout(updateProgress, 1000);
            </script>
        </body>
        </html>
    `;
    
    const newWindow = window.open('', '_blank', 'width=900,height=600');
    newWindow.document.write(syncHTML);
    newWindow.document.close();
}

// Download sync configuration file
function downloadSyncConfig(calendars, months) {
    const config = {
        calendars: calendars,
        months_to_check: parseInt(months),
        timestamp: new Date().toISOString(),
        instructions: [
            "1. Save this file as 'sync_config.json' in your SubsplashCalendarBridge folder",
            "2. Run: python sync_script.py --config sync_config.json",
            "3. Or run: python sync_script.py (it will use default settings)"
        ]
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sync_config.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Initialize the interface
document.addEventListener('DOMContentLoaded', function() {
    loadLastSync();
    
    // Add event listeners for checkboxes
    Object.keys(CALENDAR_IDS).forEach(calendarType => {
        const checkbox = document.getElementById(calendarType);
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                if (this.checked && (!CALENDAR_IDS[calendarType] || CALENDAR_IDS[calendarType] === 'your_' + calendarType + '_calendar_id_here')) {
                    showStatus(`Warning: No Google Calendar ID configured for ${calendarType}`, 'error');
                    this.checked = false;
                }
            });
        }
    });
});

// Add keyboard shortcut (Ctrl+Shift+S)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'S') {
        e.preventDefault();
        startSync();
    }
});
</script>
